trigger:
  - develop
  - azure-pipelines

resources:
  - repo: self

variables:
  - group: variable-FastAPI

stages:
  - stage: Build
    displayName: Build, push, and deploy stage
    jobs:
      - job: Build
        displayName: Build and Push
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
          - task: Bash@3
            displayName: Pull and Run Docker Container on Remote Host
            inputs:
              targetType: "inline"
              script: |
                sshpass -p '$(sshPassword)' ssh -o StrictHostKeyChecking=no $(sshUsername)@$(sshHost) -p $(sshPort) << EOF
                  az acr login --name $(dockerLogin)
                  /usr/bin/docker stop $(dockerName)
                  /usr/bin/docker rm $(dockerName)
                  /usr/bin/docker pull $(containerRegistry)/$(imageRepository):$(tag)
                  /usr/bin/docker run -d --name $(dockerName) -p $(port) $(containerRegistry)/$(imageRepository):$(tag)
                EOF
