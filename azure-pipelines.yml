trigger:
  - develop
  - azure-pipelines

resources:
  - repo: self

variables:
  dockerRegistryServiceConnection: "e909f23a-a587-4be3-8554-6cc79cbd78c0"
  imageRepository: "mavenmembersportalbe"
  containerRegistry: "mavenmemberportal.azurecr.io"
  dockerfilePath: "Dockerfile"
  tag: "$(Build.BuildId)"
  vmImageName: "ubuntu-latest"
  - name: sshUsername
    value: $[sshUsername]

stages:
  - script: echo "name is test $(sshUsername)"
  - stage: Build
    displayName: Build, push, and deploy stage
    jobs:
      - job: Build
        displayName: Build and Push
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
          - task: Bash@3
            displayName: Pull and Run Docker Container on Remote Host
            inputs:
              targetType: "inline"
              script: |
                sshpass -p $(sshPassword) ssh -o StrictHostKeyChecking=no $(sshUsername)@$(sshHost) -p $(sshPort) << EOF
                  sudo docker pull $(containerRegistry)/$(imageRepository):$(tag)
                  sudo docker run -d -p 80:80 $(containerRegistry)/$(imageRepository):$(tag)
                EOF
